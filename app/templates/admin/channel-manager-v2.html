{% extends "base.html" %}

{% block title %}Channel Manager - IPTV PVR{% endblock %}

{% block extra_css %}
<!-- Sortable.js doesn't have a CSS file -->
<style>
:root {
    --channel-card-bg: rgba(255, 255, 255, 0.95);
    --channel-card-border: #e0e0e0;
    --channel-card-hover: #f8f9fa;
    --channel-selected-bg: rgba(13, 110, 253, 0.1);
    --channel-selected-border: #0d6efd;
    --sidebar-bg: #f8f9fa;
    --drag-placeholder: rgba(13, 110, 253, 0.2);
    --text-heading: #333333;
    --text-body: #666666;
    --text-muted: #999999;
    --shadow-color: rgba(0, 0, 0, 0.1);
    --shadow-color-hover: rgba(0, 0, 0, 0.15);
    --loading-gradient: rgba(255, 255, 255, 0.4);
}

[data-bs-theme="dark"],
[data-theme="dark"],
[data-theme="spacecake"],
[data-theme="spacewars"],
.dark-mode {
    --channel-card-bg: rgba(45, 45, 45, 0.95);
    --channel-card-border: #555;
    --channel-card-hover: #3a3a3a;
    --channel-selected-bg: rgba(13, 110, 253, 0.2);
    --channel-selected-border: #4a9eff;
    --sidebar-bg: #2d2d2d;
    --drag-placeholder: rgba(13, 110, 253, 0.3);
    --text-heading: #e0e0e0;
    --text-body: #cccccc;
    --text-muted: #999999;
    --shadow-color: rgba(0, 0, 0, 0.3);
    --shadow-color-hover: rgba(0, 0, 0, 0.4);
    --loading-gradient: rgba(255, 255, 255, 0.1);
}

.channel-manager-container {
    height: calc(100vh - 120px);
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

/* Left Sidebar */
.left-sidebar {
    width: 300px;
    background: var(--sidebar-bg);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 16px var(--shadow-color);
    overflow-y: auto;
}

.search-section {
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--channel-card-border);
    border-radius: 8px;
    background: var(--channel-card-bg);
    margin-bottom: 10px;
}

.filter-section {
    margin-bottom: 20px;
}

.filter-section h6 {
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-heading, #333333);
}

.filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 15px;
}

.filter-tag {
    padding: 6px 12px;
    background: var(--channel-card-bg);
    border: 1px solid var(--channel-card-border);
    border-radius: 20px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-tag:hover,
.filter-tag.active {
    background: var(--channel-selected-bg);
    border-color: var(--channel-selected-border);
    color: var(--channel-selected-border);
}

.groups-section {
    flex: 1;
}

.group-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background: var(--channel-card-bg);
    border: 1px solid var(--channel-card-border);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.group-item:hover {
    background: var(--channel-card-hover);
}

.group-item.active {
    background: var(--channel-selected-bg);
    border-color: var(--channel-selected-border);
}

.group-count {
    background: var(--channel-selected-border);
    color: var(--bs-white, white);
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Main Content Area */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--channel-card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 16px var(--shadow-color);
    overflow: hidden;
}

.content-header {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--channel-card-border);
    background: var(--sidebar-bg);
}

.header-controls {
    margin-left: auto;
}

.sort-control select,
.per-page-control select {
    min-width: 150px;
}

.channel-info-bar {
    padding: 10px 0;
    font-size: 0.875rem;
    color: var(--text-muted);
    border-bottom: 1px solid var(--channel-card-border);
    margin-bottom: 15px;
}

.pagination-container {
    padding: 20px 0;
    border-top: 1px solid var(--channel-card-border);
    margin-top: auto;
}

.pagination {
    margin-bottom: 0;
}

.pagination .page-link {
    background: var(--channel-card-bg);
    border-color: var(--channel-card-border);
    color: var(--text-body);
}

.pagination .page-link:hover {
    background: var(--channel-card-hover);
    border-color: var(--channel-selected-border);
    color: var(--channel-selected-border);
}

.pagination .page-item.active .page-link {
    background: var(--channel-selected-border);
    border-color: var(--channel-selected-border);
    color: var(--bs-white);
}

.pagination .page-item.disabled .page-link {
    background: var(--channel-card-bg);
    border-color: var(--channel-card-border);
    color: var(--text-muted);
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.view-toggle {
    display: flex;
    background: var(--channel-card-bg);
    border-radius: 8px;
    padding: 4px;
    border: 1px solid var(--channel-card-border);
}

.view-toggle button {
    padding: 8px 12px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.view-toggle button.active {
    background: var(--channel-selected-border);
    color: var(--bs-white, white);
}

.bulk-actions-header {
    display: none;
    align-items: center;
    gap: 15px;
}

.bulk-actions-header.show {
    display: flex;
}

.selection-count {
    font-weight: 600;
    color: var(--channel-selected-border);
}

/* Channel Grid */
.channels-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.channels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
}

.channels-list {
    display: none;
    flex-direction: column;
    gap: 8px;
}

.channel-card {
    background: var(--channel-card-bg);
    border: 2px solid var(--channel-card-border);
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.channel-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px var(--shadow-color-hover);
}

.channel-card.selected {
    background: var(--channel-selected-bg);
    border-color: var(--channel-selected-border);
    box-shadow: 0 4px 20px rgba(13, 110, 253, 0.3);
}

.channel-card.dragging {
    opacity: 0.7;
    transform: rotate(5deg);
}

.channel-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.channel-logo {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    margin-right: 12px;
    background: var(--channel-card-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--text-muted, #999999);
}

.channel-info {
    flex: 1;
}

.channel-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-heading, #333333);
}

.channel-group {
    font-size: 0.875rem;
    color: var(--text-muted, #999999);
}

.channel-checkbox {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid var(--channel-card-border);
    background: var(--channel-card-bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.channel-checkbox.checked {
    background: var(--channel-selected-border);
    border-color: var(--channel-selected-border);
    color: var(--bs-white, white);
}

.channel-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.channel-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-dot.online { background: var(--bs-success, #28a745); }
.status-dot.offline { background: var(--bs-danger, #dc3545); }
.status-dot.unknown { background: var(--bs-secondary, #6c757d); }

.channel-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: var(--channel-card-border);
    color: var(--text-body, #666666);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 0.875rem;
}

.action-btn:hover {
    background: var(--channel-selected-border);
    color: var(--bs-white, white);
}

/* Right Sidebar */
.right-sidebar {
    width: 350px;
    background: var(--sidebar-bg);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px var(--shadow-color);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-section {
    background: var(--channel-card-bg);
    border-radius: 8px;
    padding: 16px;
    border: 1px solid var(--channel-card-border);
}

.sidebar-section h6 {
    margin-bottom: 12px;
    font-weight: 600;
    color: var(--text-heading, #333333);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Drag & Drop Placeholder */
.drag-placeholder {
    background: var(--drag-placeholder);
    border: 2px dashed var(--channel-selected-border);
    border-radius: 12px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--channel-selected-border);
    font-weight: 600;
}

/* Drop zones */
.drop-zone {
    min-height: 60px;
    border: 2px dashed transparent;
    border-radius: 8px;
    padding: 16px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted, #999999);
    font-style: italic;
}

.drop-zone.drag-over {
    border-color: var(--channel-selected-border);
    background: var(--drag-placeholder);
    color: var(--channel-selected-border);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.channel-card {
    animation: fadeIn 0.3s ease;
}

/* Responsive */
@media (max-width: 1200px) {
    .channel-manager-container {
        flex-direction: column;
        height: auto;
    }
    
    .left-sidebar,
    .right-sidebar {
        width: 100%;
    }
    
    .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

/* Loading States */
.loading-skeleton {
    background: linear-gradient(90deg, transparent, var(--loading-gradient), transparent);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Context Menu */
.context-menu {
    position: fixed;
    background: var(--channel-card-bg);
    border: 1px solid var(--channel-card-border);
    border-radius: 8px;
    box-shadow: 0 8px 32px var(--shadow-color-hover);
    z-index: 10000;
    padding: 8px 0;
    min-width: 180px;
}

.context-menu-item {
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s ease;
}

.context-menu-item:hover {
    background: var(--channel-card-hover);
}

.context-menu-divider {
    height: 1px;
    background: var(--channel-card-border);
    margin: 4px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Channel Manager</h1>
            <p class="text-muted mb-0">Manage channels, groups, and playlists with drag & drop</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/admin/imports" class="btn btn-outline-primary">
                <i class="bi bi-download"></i> Import Manager
            </a>
            <button class="btn btn-outline-success" id="exportBtn">
                <i class="bi bi-upload"></i> Export
            </button>
            <button class="btn btn-primary" id="addChannelBtn">
                <i class="bi bi-plus-lg"></i> Add Channel
            </button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="channel-manager-container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <!-- Search -->
            <div class="search-section">
                <input type="text" class="search-input" placeholder="Search channels..." id="channelSearch">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary flex-1" id="selectAllBtn">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary flex-1" id="clearSelectionBtn">Clear</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-section">
                <h6><i class="bi bi-funnel"></i> Filters</h6>
                <div class="filter-tags" id="statusFilters">
                    <span class="filter-tag active" data-filter="all">All</span>
                    <span class="filter-tag" data-filter="online">Online</span>
                    <span class="filter-tag" data-filter="offline">Offline</span>
                    <span class="filter-tag" data-filter="unknown">Unknown</span>
                </div>
                <div class="filter-tags" id="typeFilters">
                    <span class="filter-tag active" data-filter="all">All Types</span>
                    <span class="filter-tag" data-filter="tv">TV</span>
                    <span class="filter-tag" data-filter="radio">Radio</span>
                    <span class="filter-tag" data-filter="vod">VOD</span>
                </div>
                <div class="mt-3">
                    <label class="form-label small text-muted">EPG Mapping</label>
                    <div class="filter-tags" id="epgFilters">
                        <span class="filter-tag active" data-filter="all">All</span>
                        <span class="filter-tag" data-filter="mapped">Mapped</span>
                        <span class="filter-tag" data-filter="unmapped">Unmapped</span>
                    </div>
                </div>
            </div>

            <!-- Groups -->
            <div class="groups-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="bi bi-collection"></i> Groups</h6>
                    <button class="btn btn-sm btn-outline-primary" id="addGroupBtn">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
                <div id="groupsList">
                    <div class="group-item active" data-group-id="all">
                        <span><i class="bi bi-grid-3x3-gap"></i> All Channels</span>
                        <span class="group-count" id="totalChannelCount">0</span>
                    </div>
                    <div class="group-item" data-group-id="ungrouped">
                        <span><i class="bi bi-question-circle"></i> Ungrouped</span>
                        <span class="group-count">0</span>
                    </div>
                    <!-- Dynamic groups will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Content Header -->
            <div class="content-header">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="header-actions">
                        <div class="view-toggle">
                            <button class="active" data-view="grid"><i class="bi bi-grid-3x3-gap"></i></button>
                            <button data-view="list"><i class="bi bi-list"></i></button>
                        </div>
                        <div class="bulk-actions-header" id="bulkActionsHeader">
                            <span class="selection-count" id="selectionCount">0 selected</span>
                            <button class="btn btn-sm btn-outline-primary" id="bulkAddToGroupBtn">
                                <i class="bi bi-collection"></i> Add to Group
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="bulkMapEpgBtn">
                                <i class="bi bi-broadcast"></i> Map EPG
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="header-controls d-flex gap-3 align-items-center">
                        <!-- Sort options -->
                        <div class="sort-control">
                            <select class="form-select form-select-sm" id="sortSelect">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="number-asc">Channel # (Low-High)</option>
                                <option value="number-desc">Channel # (High-Low)</option>
                                <option value="group-asc">Group (A-Z)</option>
                                <option value="group-desc">Group (Z-A)</option>
                                <option value="status-asc">Status</option>
                            </select>
                        </div>
                        <!-- Items per page -->
                        <div class="per-page-control">
                            <select class="form-select form-select-sm" id="perPageSelect">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                                <option value="500">500 per page</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channels Container -->
            <div class="channels-container">
                <!-- Channel count and page info -->
                <div class="channel-info-bar">
                    <span id="channelCountInfo">Showing 0 of 0 channels</span>
                </div>
                <div class="channels-grid" id="channelsGrid">
                    <!-- Channels will be loaded here -->
                </div>
                <div class="channels-list" id="channelsList">
                    <!-- List view -->
                </div>
                <!-- Pagination -->
                <div class="pagination-container">
                    <nav aria-label="Channel pagination">
                        <ul class="pagination justify-content-center" id="paginationControls">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <!-- Playlists -->
            <div class="sidebar-section">
                <h6><i class="bi bi-music-note-list"></i> Playlists</h6>
                <div class="drop-zone" id="playlistDropZone">
                    Drop channels here to create playlist
                </div>
                <div id="playlistsList">
                    <!-- Existing playlists -->
                </div>
                <button class="btn btn-sm btn-outline-primary w-100 mt-2" id="createPlaylistBtn">
                    <i class="bi bi-plus"></i> Create Playlist
                </button>
            </div>

            <!-- EPG Mapping -->
            <div class="sidebar-section">
                <h6><i class="bi bi-broadcast"></i> EPG Mapping</h6>
                <div class="mb-3">
                    <label class="form-label">Auto-mapping</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-success" id="autoMapBtn">
                            <i class="bi bi-magic"></i> Auto Map
                        </button>
                        <button class="btn btn-sm btn-outline-info" id="suggestMappingBtn">
                            <i class="bi bi-lightbulb"></i> Suggest
                        </button>
                    </div>
                </div>
                <div id="epgMappingSection">
                    <!-- EPG mapping interface -->
                </div>
            </div>

            <!-- Channel Details -->
            <div class="sidebar-section" id="channelDetailsSection" style="display: none;">
                <h6><i class="bi bi-info-circle"></i> Channel Details</h6>
                <div id="channelDetails">
                    <!-- Selected channel details -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add Channel Modal -->
<div class="modal fade" id="addChannelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Channel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addChannelForm">
                    <div class="mb-3">
                        <label class="form-label">Channel Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stream URL</label>
                        <input type="url" class="form-control" name="url" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Logo URL</label>
                        <input type="url" class="form-control" name="logo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Group</label>
                        <select class="form-select" name="group_id">
                            <option value="">No Group</option>
                            <!-- Groups will be populated -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">EPG Channel ID</label>
                        <input type="text" class="form-control" name="epg_channel_id">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChannelBtn">Save Channel</button>
            </div>
        </div>
    </div>
</div>

<!-- Import/Export Modal -->
<div class="modal fade" id="importExportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importExportModalTitle">Import Channels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Import/Export interface will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu" style="display: none;">
    <div class="context-menu-item" data-action="edit">
        <i class="bi bi-pencil"></i> Edit Channel
    </div>
    <div class="context-menu-item" data-action="duplicate">
        <i class="bi bi-copy"></i> Duplicate
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="addToGroup">
        <i class="bi bi-collection"></i> Add to Group
    </div>
    <div class="context-menu-item" data-action="mapEpg">
        <i class="bi bi-broadcast"></i> Map EPG
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="delete">
        <i class="bi bi-trash"></i> Delete
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
// Channel Manager Implementation
class ChannelManager {
    constructor() {
        this.channels = [];
        this.groups = [];
        this.playlists = [];
        this.selectedChannels = new Set();
        this.currentView = 'grid';
        this.currentFilter = { status: 'all', type: 'all', group: 'all', epg: 'all' };
        this.currentSearch = '';
        this.currentSort = 'name-asc';
        this.currentPage = 1;
        this.itemsPerPage = 50;
        
        // Load state from URL
        this.loadStateFromURL();
        
        this.init();
    }
    
    async init() {
        await this.loadData();
        this.setupEventListeners();
        this.setupDragAndDrop();
        this.render();
    }
    
    loadStateFromURL() {
        const params = new URLSearchParams(window.location.search);
        
        // Load pagination
        if (params.has('page')) {
            this.currentPage = parseInt(params.get('page')) || 1;
        }
        if (params.has('perPage')) {
            this.itemsPerPage = parseInt(params.get('perPage')) || 50;
        }
        
        // Load sort
        if (params.has('sort')) {
            this.currentSort = params.get('sort');
        }
        
        // Load filters
        if (params.has('search')) {
            this.currentSearch = params.get('search');
            document.getElementById('channelSearch').value = this.currentSearch;
        }
        if (params.has('status')) {
            this.currentFilter.status = params.get('status');
        }
        if (params.has('type')) {
            this.currentFilter.type = params.get('type');
        }
        if (params.has('group')) {
            this.currentFilter.group = params.get('group');
        }
        if (params.has('epg')) {
            this.currentFilter.epg = params.get('epg');
        }
        
        // Load view
        if (params.has('view')) {
            this.currentView = params.get('view');
        }
    }
    
    updateURL() {
        const params = new URLSearchParams();
        
        // Add current state to URL
        if (this.currentPage > 1) params.set('page', this.currentPage);
        if (this.itemsPerPage !== 50) params.set('perPage', this.itemsPerPage);
        if (this.currentSort !== 'name-asc') params.set('sort', this.currentSort);
        if (this.currentSearch) params.set('search', this.currentSearch);
        if (this.currentFilter.status !== 'all') params.set('status', this.currentFilter.status);
        if (this.currentFilter.type !== 'all') params.set('type', this.currentFilter.type);
        if (this.currentFilter.group !== 'all') params.set('group', this.currentFilter.group);
        if (this.currentFilter.epg !== 'all') params.set('epg', this.currentFilter.epg);
        if (this.currentView !== 'grid') params.set('view', this.currentView);
        
        // Update URL without reloading
        const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
        window.history.replaceState({}, '', newURL);
    }
    
    sortChannels(channels) {
        const [field, direction] = this.currentSort.split('-');
        
        return [...channels].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case 'name':
                    valueA = a.name.toLowerCase();
                    valueB = b.name.toLowerCase();
                    break;
                case 'number':
                    valueA = a.channel_number || 999999;
                    valueB = b.channel_number || 999999;
                    break;
                case 'group':
                    valueA = (a.group_name || 'zzz').toLowerCase();
                    valueB = (b.group_name || 'zzz').toLowerCase();
                    break;
                case 'status':
                    const statusOrder = { 'online': 1, 'offline': 2, 'unknown': 3 };
                    valueA = statusOrder[a.status || 'unknown'];
                    valueB = statusOrder[b.status || 'unknown'];
                    break;
                default:
                    valueA = a.name.toLowerCase();
                    valueB = b.name.toLowerCase();
            }
            
            if (direction === 'desc') {
                [valueA, valueB] = [valueB, valueA];
            }
            
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        });
    }
    
    paginateChannels(channels) {
        const startIndex = (this.currentPage - 1) * this.itemsPerPage;
        const endIndex = startIndex + this.itemsPerPage;
        return channels.slice(startIndex, endIndex);
    }
    
    getTotalPages(totalItems) {
        return Math.ceil(totalItems / this.itemsPerPage);
    }
    
    changePage(page) {
        const totalPages = this.getTotalPages(this.getFilteredChannels().length);
        if (page >= 1 && page <= totalPages) {
            this.currentPage = page;
            this.render();
            this.updateURL();
            // Scroll to top of channels container
            document.querySelector('.channels-container').scrollTop = 0;
        }
    }
    
    changeItemsPerPage(perPage) {
        this.itemsPerPage = parseInt(perPage);
        this.currentPage = 1; // Reset to first page
        this.render();
        this.updateURL();
    }
    
    changeSort(sortValue) {
        this.currentSort = sortValue;
        this.currentPage = 1; // Reset to first page when sorting changes
        this.render();
        this.updateURL();
    }
    
    async loadData() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                this.showNotification('Please login to manage channels', 'error');
                window.location.href = '/login';
                return;
            }
            
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            // Load channels, groups, and playlists
            // Note: We explicitly set limit=10000 to get all channels for now
            // In the future, this should be replaced with proper server-side pagination
            const [channelsResponse, groupsResponse, playlistsResponse] = await Promise.all([
                fetch('/api/channels/?limit=10000', { headers }),
                fetch('/api/channels/groups', { headers }),
                fetch('/api/channels/playlists', { headers })
            ]);
            
            if (!channelsResponse.ok || !groupsResponse.ok || !playlistsResponse.ok) {
                throw new Error('Failed to load data');
            }
            
            this.channels = await channelsResponse.json() || [];
            this.groups = await groupsResponse.json() || [];
            this.playlists = await playlistsResponse.json() || [];
            
            // Ensure channels is an array
            if (!Array.isArray(this.channels)) {
                console.error('Channels data is not an array:', this.channels);
                this.channels = [];
            }
        } catch (error) {
            console.error('Error loading data:', error);
            this.showNotification('Error loading data', 'error');
            // Initialize with empty arrays to prevent filter errors
            this.channels = [];
            this.groups = [];
            this.playlists = [];
        }
    }
    
    setupEventListeners() {
        try {
            // Search
            const channelSearch = document.getElementById('channelSearch');
            if (channelSearch) {
                channelSearch.addEventListener('input', (e) => {
                    this.currentSearch = e.target.value;
                    this.currentPage = 1; // Reset to first page on search
                    this.render();
                    this.updateURL();
                });
            }
            
            // Sort control
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.value = this.currentSort;
                sortSelect.addEventListener('change', (e) => {
                    this.changeSort(e.target.value);
                });
            }
            
            // Items per page control
            const perPageSelect = document.getElementById('perPageSelect');
            if (perPageSelect) {
                perPageSelect.value = this.itemsPerPage;
                perPageSelect.addEventListener('change', (e) => {
                    this.changeItemsPerPage(e.target.value);
                });
            }
            
            // Filters
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', (e) => {
                    const filterType = e.target.parentElement.id.replace('Filters', '').toLowerCase();
                    const filterValue = e.target.dataset.filter;
                    
                    // Update active state
                    e.target.parentElement.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    this.currentFilter[filterType] = filterValue;
                    this.currentPage = 1; // Reset to first page when filter changes
                    this.render();
                    this.updateURL();
                });
            });
            
            // Update filter UI based on loaded state
            this.updateFilterUI();
            
            // View toggle
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.currentView = e.target.dataset.view;
                    this.toggleView();
                });
            });
            
            // Helper function to safely add event listener
            const addClickListener = (id, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', handler);
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            };
            
            // Selection
            addClickListener('selectAllBtn', () => this.selectAll());
            addClickListener('clearSelectionBtn', () => this.clearSelection());
            
            // Bulk actions
            addClickListener('bulkAddToGroupBtn', () => this.bulkAddToGroup());
            addClickListener('bulkMapEpgBtn', () => this.bulkMapEpg());
            addClickListener('bulkDeleteBtn', () => this.bulkDelete());
            
            // Buttons
            addClickListener('addChannelBtn', () => this.showAddChannelModal());
            // Import is handled by the Import Manager link
            // addClickListener('importBtn', () => this.showImportModal());
            addClickListener('exportBtn', () => this.showExportModal());
            addClickListener('addGroupBtn', () => this.addGroup());
            addClickListener('createPlaylistBtn', () => this.createPlaylist());
            
            // Auto mapping
            addClickListener('autoMapBtn', () => this.autoMapEpg());
            addClickListener('suggestMappingBtn', () => this.suggestEpgMapping());
            
            // Context menu
            document.addEventListener('contextmenu', (e) => this.showContextMenu(e));
            document.addEventListener('click', () => this.hideContextMenu());
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }
    }
    
    setupDragAndDrop() {
        try {
            // Check if Sortable is available
            if (typeof Sortable === 'undefined') {
                console.warn('Sortable.js not loaded, drag and drop disabled');
                return;
            }
            
            // Setup sortable for channels grid
            const channelsGrid = document.getElementById('channelsGrid');
            if (channelsGrid) {
                this.channelsGridSortable = new Sortable(channelsGrid, {
                    group: 'channels',
                    animation: 150,
                    ghostClass: 'drag-placeholder',
                    chosenClass: 'dragging',
                    onStart: (evt) => {
                        document.body.classList.add('dragging');
                    },
                    onEnd: (evt) => {
                        document.body.classList.remove('dragging');
                    }
                });
            }
            
            // Setup drop zones
            this.setupDropZones();
        } catch (error) {
            console.error('Error setting up drag and drop:', error);
        }
    }
    
    setupDropZones() {
        try {
            const playlistDropZone = document.getElementById('playlistDropZone');
            
            if (playlistDropZone) {
                playlistDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    playlistDropZone.classList.add('drag-over');
                });
                
                playlistDropZone.addEventListener('dragleave', () => {
                    playlistDropZone.classList.remove('drag-over');
                });
                
                playlistDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    playlistDropZone.classList.remove('drag-over');
                    this.handlePlaylistDrop(e);
                });
            }
        } catch (error) {
            console.error('Error setting up drop zones:', error);
        }
    }
    
    updateFilterUI() {
        // Update filter tags based on current state
        document.querySelectorAll('#statusFilters .filter-tag').forEach(tag => {
            tag.classList.toggle('active', tag.dataset.filter === this.currentFilter.status);
        });
        document.querySelectorAll('#typeFilters .filter-tag').forEach(tag => {
            tag.classList.toggle('active', tag.dataset.filter === this.currentFilter.type);
        });
        document.querySelectorAll('#epgFilters .filter-tag').forEach(tag => {
            tag.classList.toggle('active', tag.dataset.filter === this.currentFilter.epg);
        });
        
        // Update view toggle
        document.querySelectorAll('.view-toggle button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === this.currentView);
        });
    }
    
    render() {
        this.renderChannels();
        this.renderGroups();
        this.renderPlaylists();
        this.updateCounts();
        this.renderPagination();
    }
    
    renderChannels() {
        const filteredChannels = this.getFilteredChannels();
        const sortedChannels = this.sortChannels(filteredChannels);
        const paginatedChannels = this.paginateChannels(sortedChannels);
        const container = document.getElementById('channelsGrid');
        
        container.innerHTML = '';
        
        // Update channel count info
        const channelCountInfo = document.getElementById('channelCountInfo');
        const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
        const endIndex = Math.min(this.currentPage * this.itemsPerPage, filteredChannels.length);
        
        if (filteredChannels.length > 0) {
            channelCountInfo.textContent = `Showing ${startIndex}-${endIndex} of ${filteredChannels.length} channels`;
        } else {
            channelCountInfo.textContent = 'No channels found';
        }
        
        paginatedChannels.forEach(channel => {
            const channelCard = this.createChannelCard(channel);
            container.appendChild(channelCard);
        });
        
        if (paginatedChannels.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-tv" style="font-size: 3rem;"></i><br>No channels found</div>';
        }
    }
    
    renderPagination() {
        const container = document.getElementById('paginationControls');
        const filteredChannels = this.getFilteredChannels();
        const totalPages = this.getTotalPages(filteredChannels.length);
        
        container.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#" data-page="${this.currentPage - 1}">Previous</a>`;
        container.appendChild(prevItem);
        
        // Page numbers
        const maxVisiblePages = 7;
        let startPage = Math.max(1, this.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // First page and ellipsis
        if (startPage > 1) {
            const firstItem = document.createElement('li');
            firstItem.className = 'page-item';
            firstItem.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            container.appendChild(firstItem);
            
            if (startPage > 2) {
                const ellipsisItem = document.createElement('li');
                ellipsisItem.className = 'page-item disabled';
                ellipsisItem.innerHTML = '<span class="page-link">...</span>';
                container.appendChild(ellipsisItem);
            }
        }
        
        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            container.appendChild(pageItem);
        }
        
        // Last page and ellipsis
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisItem = document.createElement('li');
                ellipsisItem.className = 'page-item disabled';
                ellipsisItem.innerHTML = '<span class="page-link">...</span>';
                container.appendChild(ellipsisItem);
            }
            
            const lastItem = document.createElement('li');
            lastItem.className = 'page-item';
            lastItem.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
            container.appendChild(lastItem);
        }
        
        // Next button
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${this.currentPage === totalPages ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#" data-page="${this.currentPage + 1}">Next</a>`;
        container.appendChild(nextItem);
        
        // Add click handlers
        container.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = parseInt(e.target.dataset.page);
                if (page && !e.target.parentElement.classList.contains('disabled')) {
                    this.changePage(page);
                }
            });
        });
    }
    
    createChannelCard(channel) {
        const isSelected = this.selectedChannels.has(channel.id);
        const card = document.createElement('div');
        card.className = `channel-card ${isSelected ? 'selected' : ''}`;
        card.dataset.channelId = channel.id;
        card.draggable = true;
        
        card.innerHTML = `
            <div class="channel-checkbox ${isSelected ? 'checked' : ''}">
                ${isSelected ? '<i class="bi bi-check"></i>' : ''}
            </div>
            <div class="channel-header">
                <div class="channel-logo">
                    ${channel.logo ? `<img src="${channel.logo}" alt="${channel.name}" class="w-100 h-100 object-fit-cover">` : '<i class="bi bi-tv"></i>'}
                </div>
                <div class="channel-info">
                    <div class="channel-name">${channel.name}</div>
                    <div class="channel-group">${channel.group_name || 'Ungrouped'}</div>
                </div>
            </div>
            <div class="channel-details">
                <div class="channel-status">
                    <div class="status-dot ${channel.status || 'unknown'}"></div>
                    <span>${(channel.status || 'unknown').charAt(0).toUpperCase() + (channel.status || 'unknown').slice(1)}</span>
                </div>
                <div class="channel-actions">
                    <button class="action-btn" title="Edit" onclick="channelManager.editChannel(${channel.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="action-btn" title="Map EPG" onclick="channelManager.mapEpg(${channel.id})">
                        <i class="bi bi-broadcast"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Add event listeners
        card.addEventListener('click', (e) => {
            if (!e.target.closest('.action-btn') && !e.target.closest('.channel-checkbox')) {
                this.selectChannel(channel.id, e.ctrlKey || e.metaKey);
            }
        });
        
        const checkbox = card.querySelector('.channel-checkbox');
        checkbox.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleChannelSelection(channel.id);
        });
        
        return card;
    }
    
    getFilteredChannels() {
        // Ensure channels is an array before filtering
        if (!Array.isArray(this.channels)) {
            console.error('Channels is not an array:', this.channels);
            return [];
        }
        
        return this.channels.filter(channel => {
            // Search filter
            if (this.currentSearch && !channel.name.toLowerCase().includes(this.currentSearch.toLowerCase())) {
                return false;
            }
            
            // Status filter
            if (this.currentFilter.status !== 'all' && channel.status !== this.currentFilter.status) {
                return false;
            }
            
            // Type filter
            if (this.currentFilter.type !== 'all' && channel.type !== this.currentFilter.type) {
                return false;
            }
            
            // Group filter
            if (this.currentFilter.group !== 'all') {
                if (this.currentFilter.group === 'ungrouped' && channel.group_id) {
                    return false;
                }
                if (this.currentFilter.group !== 'ungrouped' && channel.group_id !== parseInt(this.currentFilter.group)) {
                    return false;
                }
            }
            
            // EPG filter
            if (this.currentFilter.epg !== 'all') {
                const hasMappedEPG = channel.epg_channel_id && channel.epg_channel_id.trim() !== '';
                if (this.currentFilter.epg === 'mapped' && !hasMappedEPG) {
                    return false;
                }
                if (this.currentFilter.epg === 'unmapped' && hasMappedEPG) {
                    return false;
                }
            }
            
            return true;
        });
    }
    
    selectChannel(channelId, multiSelect = false) {
        if (!multiSelect) {
            this.selectedChannels.clear();
        }
        
        if (this.selectedChannels.has(channelId)) {
            this.selectedChannels.delete(channelId);
        } else {
            this.selectedChannels.add(channelId);
        }
        
        this.updateSelection();
    }
    
    toggleChannelSelection(channelId) {
        if (this.selectedChannels.has(channelId)) {
            this.selectedChannels.delete(channelId);
        } else {
            this.selectedChannels.add(channelId);
        }
        
        this.updateSelection();
    }
    
    updateSelection() {
        // Update visual state
        document.querySelectorAll('.channel-card').forEach(card => {
            const channelId = parseInt(card.dataset.channelId);
            const isSelected = this.selectedChannels.has(channelId);
            const checkbox = card.querySelector('.channel-checkbox');
            
            card.classList.toggle('selected', isSelected);
            checkbox.classList.toggle('checked', isSelected);
            checkbox.innerHTML = isSelected ? '<i class="bi bi-check"></i>' : '';
        });
        
        // Update bulk actions
        const bulkActions = document.getElementById('bulkActionsHeader');
        const selectionCount = document.getElementById('selectionCount');
        
        if (this.selectedChannels.size > 0) {
            bulkActions.classList.add('show');
            selectionCount.textContent = `${this.selectedChannels.size} selected`;
        } else {
            bulkActions.classList.remove('show');
        }
    }
    
    selectAll() {
        const filteredChannels = this.getFilteredChannels();
        filteredChannels.forEach(channel => {
            this.selectedChannels.add(channel.id);
        });
        this.updateSelection();
    }
    
    clearSelection() {
        this.selectedChannels.clear();
        this.updateSelection();
    }
    
    toggleView() {
        const grid = document.getElementById('channelsGrid');
        const list = document.getElementById('channelsList');
        
        if (this.currentView === 'grid') {
            grid.style.display = 'grid';
            list.style.display = 'none';
        } else {
            grid.style.display = 'none';
            list.style.display = 'flex';
            this.renderListView();
        }
    }
    
    renderListView() {
        // Implementation for list view
        const container = document.getElementById('channelsList');
        const filteredChannels = this.getFilteredChannels();
        
        container.innerHTML = '';
        // List view implementation...
    }
    
    showNotification(message, type = 'info') {
        // Implementation similar to existing notification system
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
    
    renderGroups() {
        const groupsList = document.getElementById('groupsList');
        const allChannelsItem = groupsList.querySelector('[data-group-id="all"]');
        const ungroupedItem = groupsList.querySelector('[data-group-id="ungrouped"]');
        
        // Remove all dynamic group items
        groupsList.querySelectorAll('.group-item:not([data-group-id="all"]):not([data-group-id="ungrouped"])').forEach(item => item.remove());
        
        // Count channels per group
        const groupCounts = {};
        let ungroupedCount = 0;
        
        this.channels.forEach(channel => {
            if (channel.group_id) {
                groupCounts[channel.group_id] = (groupCounts[channel.group_id] || 0) + 1;
            } else {
                ungroupedCount++;
            }
        });
        
        // Update total and ungrouped counts
        const totalCountElement = document.getElementById('totalChannelCount');
        if (totalCountElement) {
            totalCountElement.textContent = this.channels.length;
        }
        ungroupedItem.querySelector('.group-count').textContent = ungroupedCount;
        
        // Add group items
        this.groups.forEach(group => {
            // Skip if group doesn't have an id
            if (!group || !group.id) {
                console.warn('Skipping group without id:', group);
                return;
            }
            
            const groupItem = document.createElement('div');
            groupItem.className = `group-item ${this.currentFilter.group === group.id.toString() ? 'active' : ''}`;
            groupItem.dataset.groupId = group.id;
            groupItem.innerHTML = `
                <span><i class="bi bi-folder"></i> ${group.name || 'Unnamed Group'}</span>
                <span class="group-count">${groupCounts[group.id] || 0}</span>
            `;
            
            groupItem.addEventListener('click', () => {
                // Remove active class from all items
                groupsList.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
                groupItem.classList.add('active');
                
                this.currentFilter.group = group.id.toString();
                this.currentPage = 1;
                this.render();
                this.updateURL();
            });
            
            groupsList.appendChild(groupItem);
        });
        
        // Add click handlers for all and ungrouped
        allChannelsItem.addEventListener('click', () => {
            groupsList.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
            allChannelsItem.classList.add('active');
            this.currentFilter.group = 'all';
            this.currentPage = 1;
            this.render();
            this.updateURL();
        });
        
        ungroupedItem.addEventListener('click', () => {
            groupsList.querySelectorAll('.group-item').forEach(item => item.classList.remove('active'));
            ungroupedItem.classList.add('active');
            this.currentFilter.group = 'ungrouped';
            this.currentPage = 1;
            this.render();
            this.updateURL();
        });
        
        // Set active state based on current filter
        if (this.currentFilter.group === 'all') {
            allChannelsItem.classList.add('active');
        } else if (this.currentFilter.group === 'ungrouped') {
            ungroupedItem.classList.add('active');
        }
    }
    
    renderPlaylists() {
        // Implementation for rendering playlists
        const playlistsList = document.getElementById('playlistsList');
        if (!playlistsList) return;
        
        playlistsList.innerHTML = '';
        
        this.playlists.forEach(playlist => {
            const playlistItem = document.createElement('div');
            playlistItem.className = 'playlist-item mb-2 p-2 border rounded';
            playlistItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-music-note-list"></i> ${playlist.name}</span>
                    <span class="badge bg-secondary">${playlist.channel_count || 0}</span>
                </div>
            `;
            playlistsList.appendChild(playlistItem);
        });
    }
    
    updateCounts() {
        // Update selection count
        const selectionCount = document.getElementById('selectionCount');
        if (selectionCount && this.selectedChannels.size > 0) {
            selectionCount.textContent = `${this.selectedChannels.size} selected`;
        }
        
        // Update total channel count
        const totalCount = document.getElementById('totalChannelCount');
        if (totalCount) {
            totalCount.textContent = this.channels.length;
        }
    }
    editChannel(id) { /* Implementation */ }
    mapEpg(id) { /* Implementation */ }
    showAddChannelModal() { /* Implementation */ }
    showImportModal() { /* Implementation */ }
    showExportModal() { /* Implementation */ }
    addGroup() { /* Implementation */ }
    createPlaylist() { /* Implementation */ }
    autoMapEpg() { /* Implementation */ }
    suggestEpgMapping() { /* Implementation */ }
    bulkAddToGroup() { /* Implementation */ }
    bulkMapEpg() { /* Implementation */ }
    bulkDelete() { /* Implementation */ }
    showContextMenu(e) { /* Implementation */ }
    hideContextMenu() { /* Implementation */ }
    handlePlaylistDrop(e) { /* Implementation */ }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.channelManager = new ChannelManager();
});
</script>
{% endblock %}